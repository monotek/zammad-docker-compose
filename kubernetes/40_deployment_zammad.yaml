apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: zammad
  namespace: zammad
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: zammad
        component: services
    spec:
      volumes:
      - name: cache-volume
        emptyDir: {}
      - name: data
        nfs:
          # FIXME: use the nfs service IP instead of 'zammad-nfs'
          server: 10.0.0.117
          path: /data
      - name: uploads
        nfs:
          # FIXME: use nfs service  IP instead of 'zammad-nfs'
          server: 10.0.0.117
          path: /uploads

      initContainers:
      - name: zammad-init
        image: monotek/zammad-docker-compose:zammad
        args: [ "zammad-init" ]
        imagePullPolicy: Always
        volumeMounts:
        - name: cache-volume
          mountPath: /opt/zammad/tmp
        - name: data
          mountPath: /opt/zammad/storage
        - name: uploads
          mountPath: /opt/zammad/assets/uploads

      containers:
      - name: zammad-scheduler
        image: monotek/zammad-docker-compose:zammad
        args: [ "zammad-scheduler" ]
        imagePullPolicy: Always
        volumeMounts:
        - name: cache-volume
          mountPath: /opt/zammad/tmp
        - name: data
          mountPath: /opt/zammad/storage

      - name: zammad-railsserver
        image: monotek/zammad-docker-compose:zammad
        imagePullPolicy: Always
        args: ["zammad-railsserver"]
        ports:
        - name: railsserver
          containerPort: 3000
        volumeMounts:
        - name: cache-volume
          mountPath: /opt/zammad/tmp
        - name: data
          mountPath: /opt/zammad/storage
        - name: uploads
          mountPath: /opt/zammad/assets/uploads

      - name: zammad-websocket
        image: monotek/zammad-docker-compose:zammad
        args: [ "zammad-websocket" ]
        ports:
        - name: websocket
          containerPort: 6042
        imagePullPolicy: Always
        volumeMounts:
        - name: cache-volume
          mountPath: /opt/zammad/tmp
        - name: data
          mountPath: /opt/zammad/storage
